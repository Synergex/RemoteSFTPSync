name: Build and Package .NET 8 Solution

on:
  push:
    branches:
      - WindowsService
  pull_request:

jobs:
  build:
    runs-on: windows-latest

    env:
      Configuration: Release
      OutputDir: ${{ github.workspace }}/artifacts

    steps:
    - name: Checkout source (with full history and submodules)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: 'recursive'

    - name: Setup .NET 8 SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x'

    - name: Restore NuGet packages
      run: dotnet restore

    - name: Build solution
      run: dotnet build --configuration Release --no-restore

    - name: Publish SFTPSync
      run: dotnet publish SFTPSync/SFTPSync.csproj --configuration Release --output SFTPSync/bin/Release/net8.0-windows/publish/win-x64/

    - name: Publish SFTPSyncStop
      run: dotnet publish SFTPSyncStop/SFTPSyncStop.csproj --configuration Release --output SFTPSyncStop/bin/Release/net8.0-windows/publish/win-x64/

    - name: Publish SFTPSyncUI
      run: dotnet publish SFTPSyncUI/SFTPSyncUI.csproj --configuration Release --output SFTPSyncUI/bin/Release/net8.0-windows/publish/win-x64/

    - name: Add WiX Toolset to PATH
      run: echo "C:\Program Files (x86)\WiX Toolset v3.14\bin" >> $env:GITHUB_PATH

    - name: Find MSBuild path
      id: find-msbuild
      run: |
        $msbuild = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe"
        if (!(Test-Path $msbuild)) {
          $msbuild = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Professional\MSBuild\Current\Bin\MSBuild.exe"
        }
        if (!(Test-Path $msbuild)) {
          $msbuild = "${env:ProgramFiles}\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe"
        }
        "path=$msbuild" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Set solution directory environment variable
      run: echo "CLONE_ROOT=$(pwd)" >> $GITHUB_ENV

    - name: Build WiX Setup Project
      run: |
        & "${{ steps.find-msbuild.outputs.path }}" "SFTPSyncSetup\SFTPSyncSetup.wixproj" /p:Configuration=Release /p:CloneRoot=${{ env.CLONE_ROOT }}
      shell: pwsh

    - name: Upload MSI artifact
      uses: actions/upload-artifact@v4
      with:
        name: MSI
        path: |
          **\*.msi
